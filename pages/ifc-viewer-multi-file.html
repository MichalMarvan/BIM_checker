<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="viewer.title"></title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/ifc-viewer.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-home-btn" data-i18n="btn.back">‚Üê Dom≈Ø</a>
            <div class="language-switcher">
                <button class="lang-btn active" data-lang="cs">CZ</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
            <h1 data-i18n="viewer.title">üìä IFC Multi-File Viewer</h1>
            <p data-i18n="viewer.subtitle">Naƒçtƒõte v√≠ce IFC soubor≈Ø a zobrazte je v jedn√© spoleƒçn√© tabulce</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text" data-i18n="viewer.upload">Kliknƒõte nebo p≈ôet√°hnƒõte jeden nebo v√≠ce IFC soubor≈Ø</div>
                <input type="file" id="fileInput" accept=".ifc" multiple>
            </div>
            <button class="btn btn-primary" id="loadFromStorageBtn" style="margin: 15px 0; width: 100%; font-size: 1.1em;" data-i18n="viewer.loadFromStorage">
                üì¶ Naƒç√≠st z √∫lo≈æi≈°tƒõ
            </button>
            <div class="file-list" id="fileList"></div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div data-i18n="viewer.loading">Naƒç√≠t√°m IFC soubory...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="loading-status" id="loadingStatus"></div>
        </div>

        <div class="edit-panel" id="editPanel">
            <h3 data-i18n="viewer.bulkOps">üéØ Hromadn√© operace</h3>
            <p><span data-i18n="viewer.selected">Vybr√°no</span>: <span class="selected-count" id="selectedCount">0</span> <span data-i18n="viewer.entities">entit</span> <span id="totalFilteredCount" style="color: #6c757d; font-weight: normal;"></span></p>
            <div class="edit-panel-buttons">
                <button class="btn btn-warning" id="bulkEditBtn" disabled data-i18n="viewer.bulkEdit">‚úèÔ∏è Hromadn√° √∫prava PSetu</button>
                <button class="btn btn-success" id="addPsetBtn" disabled data-i18n="viewer.addPset">‚ûï P≈ôidat PropertySet</button>
                <button class="btn btn-info" id="renamePsetBtn" disabled data-i18n="viewer.renamePset">üîÑ P≈ôejmenovat PropertySet</button>
                <button class="btn btn-info" id="renamePropertyBtn" disabled data-i18n="viewer.renameProperty">üîÑ P≈ôejmenovat Property</button>
                <button class="btn btn-primary" id="exportIfcBtn" disabled data-i18n="viewer.exportIfc">üíæ Ulo≈æit upraven√Ω IFC</button>
                <button class="btn btn-secondary" id="selectAllVisibleBtn" data-i18n="viewer.selectVisible">‚òëÔ∏è Vybrat v≈°e na str√°nce</button>
                <button class="btn btn-success" id="selectAllPagesBtn" data-i18n="viewer.selectAll">‚òëÔ∏è‚òëÔ∏è Vybrat v≈°e na V≈†ECH str√°nk√°ch</button>
                <button class="btn btn-secondary" id="deselectAllBtn" data-i18n="viewer.deselectAll">‚òê Zru≈°it v√Ωbƒõr</button>
            </div>
        </div>

        <div class="controls" id="controls">
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                <button class="btn btn-info" id="toggleSpatialTreeBtn" data-i18n="viewer.spatialTree">üå≥ Stromov√° struktura</button>
                <input type="text" id="searchInput" data-i18n-placeholder="viewer.search" placeholder="üîç Hledat... (text, /regex/, nebo Sloupec /regex/)" style="flex: 1; min-width: 250px; padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 8px;">
                <select id="entityFilter" style="padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px;">
                    <option value="" data-i18n="viewer.allEntities">V≈°echny entity</option>
                </select>
                <select id="fileFilter" style="padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px;">
                    <option value="" data-i18n="viewer.allFiles">V≈°echny soubory</option>
                </select>
                <select id="pageSizeSelectTop" style="padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-weight: 600;">
                    <option value="100" data-i18n-rows="viewer.rows">100 ≈ô√°dk≈Ø</option>
                    <option value="250" data-i18n-rows="viewer.rows">250 ≈ô√°dk≈Ø</option>
                    <option value="500" selected data-i18n-rows="viewer.rows">500 ≈ô√°dk≈Ø</option>
                    <option value="1000" data-i18n-rows="viewer.rows">1000 ≈ô√°dk≈Ø</option>
                    <option value="2500" data-i18n-rows="viewer.rows">2500 ≈ô√°dk≈Ø</option>
                    <option value="-1" data-i18n="viewer.allSlow">V≈°e (pomal√©!)</option>
                </select>
                <button class="btn btn-success" id="columnManagerBtn" data-i18n="viewer.columnManager">‚öôÔ∏è Spr√°va PropertySet≈Ø</button>
                <button class="btn btn-secondary" id="clearFiltersBtn" data-i18n="viewer.clearFilters">Vymazat filtry</button>
                <button class="btn btn-primary" id="toggleEditModeBtn" data-i18n="viewer.editMode">‚úèÔ∏è Editaƒçn√≠ re≈æim</button>
                <button class="btn btn-primary" id="exportBtn" data-i18n="btn.export">üì• Export CSV</button>
            </div>

            <div class="column-manager" id="columnManager">
                <h3 data-i18n="viewer.columnManagerTitle">üîß P≈ôesu≈àte PropertySety (‚ò∞) nebo jednotliv√© Properties (‚ãÆ)</h3>
                <div id="psetList"></div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-success" id="applyColumnsBtn" data-i18n="viewer.applyChanges">‚úì Pou≈æ√≠t zmƒõny</button>
                    <button class="btn btn-secondary" id="selectAllBtn" data-i18n="viewer.selectAllColumns">Vybrat v≈°e</button>
                    <button class="btn btn-secondary" id="deselectAllColumnsBtn" data-i18n="viewer.deselectAllColumns">Odebrat v≈°e</button>
                </div>
            </div>
        </div>

        <div class="table-container" id="tableContainer">
            <table class="data-table">
                <thead>
                    <tr class="header-row-pset" id="headerRowPset"></tr>
                    <tr class="header-row-prop" id="headerRowProp"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info">
                <span id="paginationInfo"></span>
            </div>
            <div class="pagination-controls">
                <button id="firstPageBtn" data-i18n-title="viewer.firstPage" title="Prvn√≠ str√°nka">‚èÆÔ∏è</button>
                <button id="prevPageBtn" data-i18n-title="viewer.previousPage" title="P≈ôedchoz√≠ str√°nka">‚óÄÔ∏è</button>

                <div class="page-input-group">
                    <span data-i18n="viewer.page">Str√°nka</span>
                    <input type="number" id="pageInput" min="1" value="1">
                    <span data-i18n="viewer.of">z</span> <span id="totalPages">1</span>
                    <button id="goToPageBtn" data-i18n="viewer.goTo">P≈ôej√≠t</button>
                </div>

                <button id="nextPageBtn" data-i18n-title="viewer.nextPage" title="Dal≈°√≠ str√°nka">‚ñ∂Ô∏è</button>
                <button id="lastPageBtn" data-i18n-title="viewer.lastPage" title="Posledn√≠ str√°nka">‚è≠Ô∏è</button>

                <select id="pageSizeSelect">
                    <option value="100" data-i18n-rows="viewer.rows">100 ≈ô√°dk≈Ø</option>
                    <option value="250" data-i18n-rows="viewer.rows">250 ≈ô√°dk≈Ø</option>
                    <option value="500" selected data-i18n-rows="viewer.rows">500 ≈ô√°dk≈Ø</option>
                    <option value="1000" data-i18n-rows="viewer.rows">1000 ≈ô√°dk≈Ø</option>
                    <option value="2500" data-i18n-rows="viewer.rows">2500 ≈ô√°dk≈Ø</option>
                    <option value="-1" data-i18n="viewer.allSlow">V≈°e (pomal√©!)</option>
                </select>
            </div>
        </div>

        <div id="statsSection" style="display: none; padding: 20px 40px; background: #f8f9fa;">
            <h3 data-i18n="viewer.totalStats"></h3>
            <div id="statsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Spatial Tree Panel -->
    <div class="spatial-tree-panel" id="spatialTreePanel">
        <div class="spatial-tree-header">
            <h3 data-i18n="viewer.spatialTree"></h3>
            <button class="spatial-tree-close" id="closeSpatialTreeBtn">‚úï</button>
        </div>
        <div class="spatial-tree-content" id="spatialTreeContent">
            <div class="spatial-tree-info" data-i18n="viewer.loadIfcForStructure"></div>
        </div>
    </div>

    <!-- Spatial Tree Overlay -->
    <div class="spatial-tree-overlay" id="spatialTreeOverlay"></div>

    <!-- Modals -->
    <div id="bulkEditModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 data-i18n="viewer.bulkEditPset"></h2>
                <button class="modal-close" onclick="closeBulkEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="parser.facet.propertySet"></label>
                    <select id="bulkPsetName">
                        <option value="" data-i18n="viewer.selectPset"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-i18n="parser.facet.property"></label>
                    <select id="bulkPropName" disabled>
                        <option value="" data-i18n="viewer.selectProp"></option>
                    </select>
                </div>
                <div id="currentValuesSection" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin: 0 0 10px 0; color: #2d3748; font-size: 1em;" data-i18n="viewer.currentValues"></h4>
                    <div id="currentValuesList" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                <div class="form-group">
                    <label data-i18n="viewer.newValue"></label>
                    <input type="text" id="bulkValue" data-i18n-placeholder="viewer.enterNewValue">
                </div>
                <p style="color: #6c757d; font-size: 0.9em;">
                    <span data-i18n="viewer.bulkEditInfo"></span> <span id="bulkEditCount" style="font-weight: 700;">0</span> <span data-i18n="viewer.entities"></span>.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkEditModal()" data-i18n="btn.cancel"></button>
                <button class="btn btn-warning" onclick="applyBulkEdit()" data-i18n="viewer.applyChanges"></button>
            </div>
        </div>
    </div>

    <!-- Storage Picker Modal -->
    <div id="storagePickerModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h2 data-i18n="viewer.modalIfcTitle"></h2>
                <button class="modal-close" onclick="closeStoragePickerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #6c757d;" data-i18n="viewer.selectMultiple"></p>
                <div id="storageFileTree" style="max-height: 400px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <!-- Tree structure will be rendered here -->
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #eef2ff; border-radius: 6px;">
                    <strong data-i18n="viewer.selectedCount"></strong> <span id="selectedFilesCount">0</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStoragePickerModal()" data-i18n="btn.cancel"></button>
                <button class="btn btn-primary" onclick="loadSelectedFilesFromStorage()" data-i18n="validator.confirmSelection"></button>
            </div>
        </div>
    </div>

    <div id="addPsetModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 data-i18n="viewer.addPset"></h2>
                <button class="modal-close" onclick="closeAddPsetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="viewer.newPsetName"></label>
                    <input type="text" id="newPsetName" data-i18n-placeholder="viewer.examplePsetName">
                </div>
                <div class="form-group">
                    <label data-i18n="viewer.newPropName"></label>
                    <input type="text" id="newPropName" data-i18n-placeholder="viewer.examplePropName">
                </div>
                <div class="form-group">
                    <label data-i18n="parser.facet.value"></label>
                    <input type="text" id="newPropValue" data-i18n-placeholder="viewer.enterValue">
                </div>
                <p style="color: #6c757d; font-size: 0.9em;">
                    <span data-i18n="viewer.addPsetInfo"></span> <span id="addPsetCount" style="font-weight: 700;">0</span> <span data-i18n="viewer.entities"></span>.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddPsetModal()" data-i18n="btn.cancel"></button>
                <button class="btn btn-success" onclick="applyAddPset()" data-i18n="viewer.add"></button>
            </div>
        </div>
    </div>

    <div id="renamePsetModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 data-i18n="viewer.renamePset"></h2>
                <button class="modal-close" onclick="closeRenamePsetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="viewer.oldPsetName"></label>
                    <select id="oldPsetName" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                        <option value="" data-i18n="viewer.selectPset"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-i18n="viewer.newPsetName"></label>
                    <input type="text" id="newPsetNameRename" data-i18n-placeholder="viewer.exampleCustomPset">
                </div>
                <p style="color: #6c757d; font-size: 0.9em;">
                    <span data-i18n="viewer.renamePsetInfo"></span> <span id="renamePsetCount" style="font-weight: 700;">0</span> <span data-i18n="viewer.entities"></span>.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRenamePsetModal()" data-i18n="btn.cancel"></button>
                <button class="btn btn-info" onclick="applyPsetRename()" data-i18n="viewer.rename"></button>
            </div>
        </div>
    </div>

    <div id="renamePropertyModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 data-i18n="viewer.renameProperty"></h2>
                <button class="modal-close" onclick="closeRenamePropertyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="parser.facet.propertySet"></label>
                    <select id="renamePropPsetName" onchange="updatePropertyDropdown()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                        <option value="" data-i18n="viewer.selectPset"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-i18n="viewer.oldPropName"></label>
                    <select id="oldPropertyName" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;" disabled>
                        <option value="" data-i18n="viewer.selectProp"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-i18n="viewer.newPropName"></label>
                    <input type="text" id="newPropertyName" data-i18n-placeholder="viewer.exampleCustomProp">
                </div>
                <p style="color: #6c757d; font-size: 0.9em;">
                    <span data-i18n="viewer.renamePropInfo"></span> <span id="renamePropertyCount" style="font-weight: 700;">0</span> <span data-i18n="viewer.entities"></span>.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRenamePropertyModal()" data-i18n="btn.cancel"></button>
                <button class="btn btn-info" onclick="applyPropertyRename()" data-i18n="viewer.rename"></button>
            </div>
        </div>
    </div>

    <script src="../assets/js/common/translations.js"></script>
    <script src="../assets/js/common/i18n.js"></script>
    <script src="../assets/js/common/error-handler.js"></script>
    <script src="../assets/js/common/storage.js"></script>
    <script src="../assets/js/viewer.js"></script>
</body>
</html>
