<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIM Checker - N√°stroje pro pr√°ci s IFC a IDS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }

        .content {
            padding: 60px 40px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .tool-card {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .tool-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .tool-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .tool-description {
            color: #6c757d;
            line-height: 1.6;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .tool-features {
            text-align: left;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .tool-features ul {
            list-style: none;
            padding: 0;
        }

        .tool-features li {
            padding: 5px 0;
            color: #495057;
            font-size: 0.9em;
        }

        .tool-features li:before {
            content: "‚úì ";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }

        .about-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 40px;
            margin-top: 40px;
            border: 2px solid #e9ecef;
        }

        .about-section h2 {
            color: #2d3748;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .about-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .about-item {
            text-align: center;
        }

        .about-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .about-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .about-text {
            color: #6c757d;
            line-height: 1.6;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            border-top: 2px solid #e9ecef;
            margin-top: 40px;
        }

        .footer p {
            margin-bottom: 10px;
        }

        .tech-stack {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .tech-badge {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Storage Section */
        .storage-section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 2em;
            color: #2d3748;
            margin-bottom: 10px;
            text-align: center;
        }

        .section-subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .storage-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        .storage-panel {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .panel-header h3 {
            font-size: 1.3em;
            color: #2d3748;
            margin: 0;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: #667eea;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .drop-zone {
            background: white;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .drop-zone:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #eef2ff;
            transform: scale(1.02);
        }

        .drop-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .drop-zone p {
            margin: 5px 0;
            color: #4a5568;
        }

        .drop-hint {
            font-size: 0.9em;
            color: #a0aec0;
        }

        .file-tree {
            flex: 1;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            min-height: 200px;
            max-height: 400px;
        }

        .file-tree:empty::before {
            content: "≈Ω√°dn√© soubory";
            color: #a0aec0;
            font-style: italic;
            display: block;
            text-align: center;
            padding: 20px;
        }

        .tree-folder {
            margin-bottom: 8px;
        }

        .tree-folder-header {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            user-select: none;
        }

        .tree-folder-header:hover {
            background: #f7fafc;
        }

        .tree-folder-header.selected {
            background: #eef2ff;
            border: 2px solid #667eea;
        }

        .folder-arrow {
            margin-right: 6px;
            font-size: 0.8em;
            color: #667eea;
            font-weight: bold;
            display: inline-block;
            width: 12px;
            text-align: center;
        }

        .folder-icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .folder-name {
            flex: 1;
            font-weight: 600;
            color: #2d3748;
        }

        .folder-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tree-folder-header:hover .folder-actions {
            opacity: 1;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .action-btn:hover {
            background: #e2e8f0;
        }

        .tree-folder-children {
            margin-left: 20px;
            display: none;
        }

        .tree-folder-children.expanded {
            display: block;
        }

        .tree-file {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 4px 0;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .tree-file:hover {
            background: #f7fafc;
        }

        .tree-file.selected {
            background: #eef2ff;
            border: 2px solid #667eea;
        }

        .file-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .file-name {
            flex: 1;
            color: #4a5568;
            font-size: 0.95em;
        }

        .file-size {
            font-size: 0.85em;
            color: #a0aec0;
            margin-right: 8px;
        }

        .file-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tree-file:hover .file-actions {
            opacity: 1;
        }

        .storage-stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
            color: #6c757d;
        }

        .storage-stats strong {
            color: #667eea;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 1000;
            min-width: 180px;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4a5568;
        }

        .context-menu-item:hover {
            background: #f7fafc;
        }

        .context-menu-item.danger:hover {
            background: #fff5f5;
            color: #e53e3e;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            color: #2d3748;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .loading-subtext {
            color: #6c757d;
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }

        .file-info {
            font-size: 0.9em;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 1em;
            }

            .content {
                padding: 40px 20px;
            }

            .storage-grid {
                grid-template-columns: 1fr;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }

            .about-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="header">
            <h1>üèóÔ∏è BIM Checker</h1>
            <p>Profesion√°ln√≠ n√°stroje pro validaci a anal√Ωzu BIM dat</p>
        </div>

        <div class="content">
            <!-- FILE STORAGE SECTION -->
            <div class="storage-section">
                <h2 class="section-title">üì¶ √ölo≈æi≈°tƒõ soubor≈Ø</h2>
                <p class="section-subtitle">Nahrajte a organizujte sv√© IFC a IDS soubory pro snadn√© pou≈æit√≠ nap≈ô√≠ƒç aplikacemi</p>

                <div class="storage-grid">
                    <!-- IFC Storage Panel -->
                    <div class="storage-panel">
                        <div class="panel-header">
                            <h3>üèóÔ∏è IFC Soubory</h3>
                            <div class="panel-actions">
                                <button class="btn-icon" id="ifcNewFolderBtn" title="Nov√° slo≈æka">üìÅ+</button>
                                <button class="btn-icon" id="ifcUploadBtn" title="Nahr√°t soubory">‚¨ÜÔ∏è</button>
                                <button class="btn-icon" id="ifcExpandAllBtn" title="Rozbalit v≈°e">‚¨áÔ∏è</button>
                                <button class="btn-icon" id="ifcCollapseAllBtn" title="Sbalit v≈°e">‚¨ÜÔ∏è</button>
                            </div>
                        </div>
                        <div class="drop-zone" id="ifcDropZone">
                            <div class="drop-zone-content">
                                <div class="drop-icon">üìÅ</div>
                                <p>P≈ôet√°hnƒõte IFC soubory sem</p>
                                <p class="drop-hint">nebo kliknƒõte pro v√Ωbƒõr</p>
                            </div>
                        </div>
                        <div class="file-tree" id="ifcFileTree"></div>
                        <div class="storage-stats" id="ifcStats">
                            <span>Soubor≈Ø: <strong>0</strong></span>
                            <span>Velikost: <strong>0 KB</strong></span>
                        </div>
                        <input type="file" id="ifcFileInput" accept=".ifc" multiple style="display: none;">
                    </div>

                    <!-- IDS Storage Panel -->
                    <div class="storage-panel">
                        <div class="panel-header">
                            <h3>üìã IDS Soubory</h3>
                            <div class="panel-actions">
                                <button class="btn-icon" id="idsNewFolderBtn" title="Nov√° slo≈æka">üìÅ+</button>
                                <button class="btn-icon" id="idsUploadBtn" title="Nahr√°t soubory">‚¨ÜÔ∏è</button>
                                <button class="btn-icon" id="idsExpandAllBtn" title="Rozbalit v≈°e">‚¨áÔ∏è</button>
                                <button class="btn-icon" id="idsCollapseAllBtn" title="Sbalit v≈°e">‚¨ÜÔ∏è</button>
                            </div>
                        </div>
                        <div class="drop-zone" id="idsDropZone">
                            <div class="drop-zone-content">
                                <div class="drop-icon">üìã</div>
                                <p>P≈ôet√°hnƒõte IDS soubory sem</p>
                                <p class="drop-hint">nebo kliknƒõte pro v√Ωbƒõr</p>
                            </div>
                        </div>
                        <div class="file-tree" id="idsFileTree"></div>
                        <div class="storage-stats" id="idsStats">
                            <span>Soubor≈Ø: <strong>0</strong></span>
                            <span>Velikost: <strong>0 KB</strong></span>
                        </div>
                        <input type="file" id="idsFileInput" accept=".ids,.xml" multiple style="display: none;">
                    </div>
                </div>
            </div>

            <div class="tools-grid">
                <a href="pages/ifc-viewer-multi-file.html" class="tool-card">
                    <div class="tool-icon">üìä</div>
                    <div class="tool-title">IFC Multi-File Viewer</div>
                    <div class="tool-description">
                        Pokroƒçil√Ω prohl√≠≈æeƒç pro anal√Ωzu a porovn√°n√≠ v√≠ce IFC soubor≈Ø souƒçasnƒõ
                    </div>
                    <div class="tool-features">
                        <ul>
                            <li>Naƒçten√≠ v√≠ce IFC soubor≈Ø</li>
                            <li>Spoleƒçn√° tabulka v≈°ech entit</li>
                            <li>Pokroƒçil√© vyhled√°v√°n√≠ (text/regex)</li>
                            <li>Spr√°va PropertySet≈Ø</li>
                            <li>Export do CSV</li>
                            <li>Str√°nkov√°n√≠ a filtry</li>
                        </ul>
                    </div>
                </a>

                <a href="pages/ids-parser-visualizer.html" class="tool-card">
                    <div class="tool-icon">üîç</div>
                    <div class="tool-title">IDS Parser a Vizualiz√©r</div>
                    <div class="tool-description">
                        N√°stroj pro zobrazen√≠ a anal√Ωzu IDS (Information Delivery Specification) soubor≈Ø
                    </div>
                    <div class="tool-features">
                        <ul>
                            <li>Parsov√°n√≠ IDS soubor≈Ø</li>
                            <li>Vizu√°ln√≠ zobrazen√≠ specifikac√≠</li>
                            <li>Stromov√° struktura</li>
                            <li>Raw XML zobrazen√≠</li>
                            <li>Regex pattern vysvƒõtlen√≠</li>
                            <li>Rozbalovac√≠ sekce</li>
                        </ul>
                    </div>
                </a>

                <a href="pages/ids-ifc-validator.html" class="tool-card">
                    <div class="tool-icon">‚úÖ</div>
                    <div class="tool-title">IDS-IFC Valid√°tor</div>
                    <div class="tool-description">
                        Validace IFC model≈Ø proti IDS specifikac√≠m pro kontrolu kvality dat
                    </div>
                    <div class="tool-features">
                        <ul>
                            <li>Validace IFC podle IDS</li>
                            <li>Applicability & Requirements</li>
                            <li>Detailn√≠ v√Ωsledky validace</li>
                            <li>Statistiky √∫spƒõ≈°nosti</li>
                            <li>Filtrov√°n√≠ v√Ωsledk≈Ø</li>
                            <li>CSV export</li>
                        </ul>
                    </div>
                </a>
            </div>

            <div class="about-section">
                <h2>üìö O projektu</h2>
                <div class="about-content">
                    <div class="about-item">
                        <div class="about-icon">üéØ</div>
                        <div class="about-title">√öƒçel</div>
                        <div class="about-text">
                            BIM Checker je sada n√°stroj≈Ø pro pr√°ci s IFC a IDS standardy.
                            Umo≈æ≈àuje kontrolu kvality, anal√Ωzu a validaci BIM dat podle
                            buildingSMART standard≈Ø.
                        </div>
                    </div>

                    <div class="about-item">
                        <div class="about-icon">üîß</div>
                        <div class="about-title">Technologie</div>
                        <div class="about-text">
                            Aplikace bƒõ≈æ√≠ p≈ô√≠mo v prohl√≠≈æeƒçi bez nutnosti instalace.
                            Ve≈°ker√© zpracov√°n√≠ prob√≠h√° lok√°lnƒõ na va≈°em za≈ô√≠zen√≠,
                            data nejsou odes√≠l√°na na server.
                        </div>
                    </div>

                    <div class="about-item">
                        <div class="about-icon">üåü</div>
                        <div class="about-title">V√Ωhody</div>
                        <div class="about-text">
                            Rychl√©, bezpeƒçn√© a bez z√°vislost√≠. ≈Ω√°dn√° registrace,
                            ≈æ√°dn√© limity, ≈æ√°dn√© nahr√°v√°n√≠ dat na cloud.
                            V≈°e funguje offline po prvn√≠m naƒçten√≠.
                        </div>
                    </div>

                    <div class="about-item">
                        <div class="about-icon">üìñ</div>
                        <div class="about-title">Standardy</div>
                        <div class="about-text">
                            Implementov√°no podle buildingSMART standard≈Ø.
                            Podporuje IFC 4.x a IDS 1.0 specifikace
                            pro zaji≈°tƒõn√≠ interoperability.
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p><strong>BIM Checker</strong> - N√°stroje pro pr√°ci s BIM daty</p>
                <p>Verze 1.0 | 2024</p>
                <div class="tech-stack">
                    <span class="tech-badge">HTML5</span>
                    <span class="tech-badge">CSS3</span>
                    <span class="tech-badge">JavaScript</span>
                    <span class="tech-badge">IFC</span>
                    <span class="tech-badge">IDS</span>
                    <span class="tech-badge">buildingSMART</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Nahr√°v√°m soubory...</div>
            <div class="loading-subtext" id="loadingSubtext">Pros√≠m ƒçekejte...</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="file-info" id="fileInfo"></div>
        </div>
    </div>

    <script>
        // =======================
        // INDEXEDDB WRAPPER
        // =======================
        class IndexedDBStorage {
            constructor(dbName) {
                this.dbName = dbName;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('storage')) {
                            db.createObjectStore('storage', { keyPath: 'key' });
                        }
                    };
                });
            }

            async get(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['storage'], 'readonly');
                    const store = transaction.objectStore('storage');
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result?.value);
                    request.onerror = () => reject(request.error);
                });
            }

            async set(key, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['storage'], 'readwrite');
                    const store = transaction.objectStore('storage');
                    const request = store.put({ key, value });

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // =======================
        // STORAGE MANAGER
        // =======================
        class StorageManager {
            constructor(storageKey) {
                this.storageKey = storageKey;
                this.idb = new IndexedDBStorage('bim_checker_storage');
                this.data = null;
                this.ready = false;
            }

            async init() {
                await this.idb.init();
                await this.load();
                this.ready = true;
            }

            async load() {
                const stored = await this.idb.get(this.storageKey);
                if (stored) {
                    this.data = stored;
                } else {
                    this.data = {
                        folders: {
                            root: {
                                id: 'root',
                                name: 'Ko≈ôenov√° slo≈æka',
                                parent: null,
                                children: [],
                                files: [],
                                expanded: true
                            }
                        },
                        files: {}
                    };
                }
            }

            async save() {
                try {
                    await this.idb.set(this.storageKey, this.data);
                    return true;
                } catch (e) {
                    console.error('Error saving storage:', e);
                    alert('Chyba p≈ôi ukl√°d√°n√≠ dat!');
                    return false;
                }
            }

            // Folder operations
            async createFolder(name, parentId = 'root') {
                const id = 'folder_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.data.folders[id] = {
                    id,
                    name,
                    parent: parentId,
                    children: [],
                    files: [],
                    expanded: false
                };
                this.data.folders[parentId].children.push(id);
                await this.save();
                return id;
            }

            async renameFolder(folderId, newName) {
                if (this.data.folders[folderId]) {
                    this.data.folders[folderId].name = newName;
                    await this.save();
                    return true;
                }
                return false;
            }

            async deleteFolder(folderId) {
                if (folderId === 'root') return false;
                const folder = this.data.folders[folderId];
                if (!folder) return false;

                // Delete all files in folder
                folder.files.forEach(fileId => delete this.data.files[fileId]);

                // Recursively delete child folders
                folder.children.forEach(childId => this.deleteFolder(childId));

                // Remove from parent
                const parent = this.data.folders[folder.parent];
                if (parent) {
                    parent.children = parent.children.filter(id => id !== folderId);
                }

                delete this.data.folders[folderId];
                await this.save();
                return true;
            }

            // File operations
            async addFile(file, folderId = 'root') {
                const id = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.data.files[id] = {
                    id,
                    name: file.name,
                    size: file.size,
                    content: file.content,
                    folder: folderId,
                    uploadDate: new Date().toISOString()
                };
                this.data.folders[folderId].files.push(id);
                await this.save();
                return id;
            }

            async deleteFile(fileId) {
                const file = this.data.files[fileId];
                if (!file) return false;

                const folder = this.data.folders[file.folder];
                if (folder) {
                    folder.files = folder.files.filter(id => id !== fileId);
                }

                delete this.data.files[fileId];
                await this.save();
                return true;
            }

            async moveFile(fileId, targetFolderId) {
                const file = this.data.files[fileId];
                if (!file || !this.data.folders[targetFolderId]) return false;

                // Remove from old folder
                const oldFolder = this.data.folders[file.folder];
                if (oldFolder) {
                    oldFolder.files = oldFolder.files.filter(id => id !== fileId);
                }

                // Add to new folder
                file.folder = targetFolderId;
                this.data.folders[targetFolderId].files.push(fileId);
                await this.save();
                return true;
            }

            async toggleFolder(folderId) {
                if (this.data.folders[folderId]) {
                    this.data.folders[folderId].expanded = !this.data.folders[folderId].expanded;
                    await this.save();
                }
            }

            getStats() {
                const fileCount = Object.keys(this.data.files).length;
                const totalSize = Object.values(this.data.files).reduce((sum, file) => sum + file.size, 0);
                return { fileCount, totalSize };
            }
        }

        // =======================
        // FILE PANEL
        // =======================
        class FilePanel {
            constructor(type, storageKey) {
                this.type = type; // 'ifc' or 'ids'
                this.storage = new StorageManager(storageKey);
                this.selectedFolder = 'root';
                this.selectedFile = null;

                this.elements = {
                    dropZone: document.getElementById(`${type}DropZone`),
                    fileTree: document.getElementById(`${type}FileTree`),
                    fileInput: document.getElementById(`${type}FileInput`),
                    stats: document.getElementById(`${type}Stats`),
                    newFolderBtn: document.getElementById(`${type}NewFolderBtn`),
                    uploadBtn: document.getElementById(`${type}UploadBtn`),
                    expandAllBtn: document.getElementById(`${type}ExpandAllBtn`),
                    collapseAllBtn: document.getElementById(`${type}CollapseAllBtn`)
                };

                this.init();
            }

            async init() {
                // Wait for storage to be ready
                await this.storage.init();
                // Drop zone events
                this.elements.dropZone.addEventListener('click', () => {
                    this.elements.fileInput.click();
                });

                this.elements.dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.elements.dropZone.classList.add('drag-over');
                });

                this.elements.dropZone.addEventListener('dragleave', () => {
                    this.elements.dropZone.classList.remove('drag-over');
                });

                this.elements.dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.elements.dropZone.classList.remove('drag-over');
                    this.handleFiles(Array.from(e.dataTransfer.files));
                });

                // File input
                this.elements.fileInput.addEventListener('change', (e) => {
                    this.handleFiles(Array.from(e.target.files));
                    e.target.value = ''; // Reset
                });

                // Buttons
                this.elements.newFolderBtn.addEventListener('click', () => this.createNewFolder());
                this.elements.uploadBtn.addEventListener('click', () => this.elements.fileInput.click());
                this.elements.expandAllBtn.addEventListener('click', () => this.expandAll());
                this.elements.collapseAllBtn.addEventListener('click', () => this.collapseAll());

                this.render();
            }

            async handleFiles(files) {
                const extensions = this.type === 'ifc' ? ['.ifc'] : ['.ids', '.xml'];
                const validFiles = files.filter(f => {
                    const name = f.name.toLowerCase();
                    return extensions.some(ext => name.endsWith(ext));
                });

                if (validFiles.length === 0) {
                    alert(`Pouze ${extensions.join(', ')} soubory jsou povoleny!`);
                    return;
                }

                // Check for large files and warn user
                const largeFiles = validFiles.filter(f => f.size > 50 * 1024 * 1024); // 50 MB
                if (largeFiles.length > 0) {
                    const fileList = largeFiles.map(f => `${f.name} (${(f.size / 1024 / 1024).toFixed(1)} MB)`).join('\n');
                    const proceed = confirm(
                        `Nƒõkter√© soubory jsou velk√© a nahr√°v√°n√≠ m≈Ø≈æe trvat d√©le:\n\n${fileList}\n\nPokraƒçovat?`
                    );
                    if (!proceed) return;
                }

                // Show loading overlay
                const loadingOverlay = document.getElementById('loadingOverlay');
                const progressBar = document.getElementById('progressBar');
                const loadingSubtext = document.getElementById('loadingSubtext');
                const fileInfo = document.getElementById('fileInfo');

                loadingOverlay.classList.add('show');

                let processed = 0;
                for (const file of validFiles) {
                    const fileNum = processed + 1;
                    const sizeMB = (file.size / 1024 / 1024).toFixed(1);

                    loadingSubtext.textContent = `Soubor ${fileNum} z ${validFiles.length}`;
                    fileInfo.textContent = `${file.name} (${sizeMB} MB)`;

                    const reader = new FileReader();

                    // Progress for reading file
                    reader.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percentRead = Math.round((e.loaded / e.total) * 100);
                            const overallPercent = Math.round(
                                ((processed + (percentRead / 100)) / validFiles.length) * 100
                            );
                            progressBar.style.width = overallPercent + '%';
                            progressBar.textContent = overallPercent + '%';
                        }
                    };

                    await new Promise((resolve) => {
                        reader.onload = async (e) => {
                            loadingSubtext.textContent = 'Ukl√°d√°m do datab√°ze...';
                            await this.storage.addFile({
                                name: file.name,
                                size: file.size,
                                content: e.target.result
                            }, this.selectedFolder);
                            processed++;

                            const overallPercent = Math.round((processed / validFiles.length) * 100);
                            progressBar.style.width = overallPercent + '%';
                            progressBar.textContent = overallPercent + '%';

                            resolve();
                        };
                        reader.onerror = () => {
                            alert(`Chyba p≈ôi ƒçten√≠ souboru: ${file.name}`);
                            processed++;
                            resolve();
                        };
                        reader.readAsText(file);
                    });
                }

                // Hide loading overlay
                loadingOverlay.classList.remove('show');

                this.render();
                alert(`‚úì √öspƒõ≈°nƒõ nahr√°no ${validFiles.length} soubor≈Ø`);
            }

            async createNewFolder() {
                const name = prompt('N√°zev nov√© slo≈æky:');
                if (name && name.trim()) {
                    await this.storage.createFolder(name.trim(), this.selectedFolder);
                    this.render();
                }
            }

            async deleteFolder(folderId) {
                if (confirm('Smazat slo≈æku a v≈°echny jej√≠ soubory?')) {
                    await this.storage.deleteFolder(folderId);
                    this.render();
                }
            }

            async renameFolder(folderId) {
                const folder = this.storage.data.folders[folderId];
                const newName = prompt('Nov√Ω n√°zev slo≈æky:', folder.name);
                if (newName && newName.trim()) {
                    await this.storage.renameFolder(folderId, newName.trim());
                    this.render();
                }
            }

            async deleteFile(fileId) {
                if (confirm('Smazat soubor?')) {
                    await this.storage.deleteFile(fileId);
                    this.render();
                }
            }

            async expandAll() {
                Object.values(this.storage.data.folders).forEach(folder => {
                    folder.expanded = true;
                });
                await this.storage.save();
                this.render();
            }

            async collapseAll() {
                Object.values(this.storage.data.folders).forEach(folder => {
                    if (folder.id !== 'root') folder.expanded = false;
                });
                await this.storage.save();
                this.render();
            }

            renderFolder(folderId, level = 0) {
                const folder = this.storage.data.folders[folderId];
                if (!folder) return '';

                const isExpanded = folder.expanded;
                const hasChildren = folder.children.length > 0 || folder.files.length > 0;

                // Arrow for expand/collapse
                const arrow = hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : '';

                let html = `
                    <div class="tree-folder" data-folder-id="${folderId}">
                        <div class="tree-folder-header ${this.selectedFolder === folderId ? 'selected' : ''}"
                             onclick="filePanel_${this.type}.selectFolder('${folderId}')">
                            <span class="folder-arrow">${arrow}</span>
                            <span class="folder-icon">üìÅ</span>
                            <span class="folder-name">${folder.name}</span>
                            ${folderId !== 'root' ? `
                            <div class="folder-actions">
                                <button class="action-btn" onclick="event.stopPropagation(); filePanel_${this.type}.renameFolder('${folderId}')" title="P≈ôejmenovat">‚úèÔ∏è</button>
                                <button class="action-btn" onclick="event.stopPropagation(); filePanel_${this.type}.deleteFolder('${folderId}')" title="Smazat">üóëÔ∏è</button>
                            </div>` : ''}
                        </div>
                        <div class="tree-folder-children ${isExpanded ? 'expanded' : ''}">
                `;

                // Render child folders FIRST (sorted by name)
                const childFolders = folder.children
                    .map(id => this.storage.data.folders[id])
                    .filter(f => f)
                    .sort((a, b) => a.name.localeCompare(b.name));

                childFolders.forEach(childFolder => {
                    html += this.renderFolder(childFolder.id, level + 1);
                });

                // Render files AFTER folders (sorted by name)
                const files = folder.files
                    .map(id => this.storage.data.files[id])
                    .filter(f => f)
                    .sort((a, b) => a.name.localeCompare(b.name));

                files.forEach(file => {
                    const sizeKB = (file.size / 1024).toFixed(1);
                    html += `
                        <div class="tree-file ${this.selectedFile === file.id ? 'selected' : ''}"
                             data-file-id="${file.id}"
                             onclick="filePanel_${this.type}.selectFile('${file.id}')">
                            <span class="file-icon">üìÑ</span>
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${sizeKB} KB</span>
                            <div class="file-actions">
                                <button class="action-btn" onclick="event.stopPropagation(); filePanel_${this.type}.deleteFile('${file.id}')" title="Smazat">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                return html;
            }

            render() {
                this.elements.fileTree.innerHTML = this.renderFolder('root');

                // Update stats
                const stats = this.storage.getStats();
                const sizeKB = (stats.totalSize / 1024).toFixed(1);
                this.elements.stats.innerHTML = `
                    <span>Soubor≈Ø: <strong>${stats.fileCount}</strong></span>
                    <span>Velikost: <strong>${sizeKB} KB</strong></span>
                `;
            }

            async selectFolder(folderId) {
                const folder = this.storage.data.folders[folderId];
                if (folder) {
                    // Toggle expand/collapse
                    await this.storage.toggleFolder(folderId);
                    this.selectedFolder = folderId;
                    this.render();
                }
            }

            selectFile(fileId) {
                this.selectedFile = fileId;
                this.render();
            }

            // Public API for other pages
            getFile(fileId) {
                return this.storage.data.files[fileId];
            }

            getAllFiles() {
                return Object.values(this.storage.data.files);
            }
        }

        // =======================
        // INITIALIZE
        // =======================
        let filePanel_ifc, filePanel_ids;

        window.addEventListener('DOMContentLoaded', () => {
            filePanel_ifc = new FilePanel('ifc', 'bim_checker_ifc_storage');
            filePanel_ids = new FilePanel('ids', 'bim_checker_ids_storage');
        });
    </script>
</body>
</html>
